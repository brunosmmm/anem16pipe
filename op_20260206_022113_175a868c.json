{
  "author": {
    "email": "brunosmmm@gmail.com",
    "name": "Bruno Morais"
  },
  "data": {
    "branch": "master",
    "content": "\n# Phase 2: Hazard Unit Completion\n\n## What Was Done\n\n### Hazard Unit Rewrite (`control/hazunit.vhd`)\nComplete rewrite of the hazard detection unit fixing 6 bugs:\n\n1. **LW hazard detection** (wrong register comparison):\n   - Old: `reg_sela_id = reg_sela_alu` OR `reg_sela_id = reg_selb_alu`\n   - New: `reg_sela_alu = reg_sela_id` OR `reg_sela_alu = reg_selb_id` (checks LW dest against both source regs of dependent, excludes $0)\n\n2. **LW hazard verification** (inverted logic):\n   - Old: allow-list of \"hazardous\" opcodes (included LIU/BHLEQ which don't read regs, missed SW/LW/JR)\n   - New: deny-list \u2014 defaults to '1' (hazard), excludes LIU, LIL, J, JAL, BZ_X/T/N, BHLEQ\n\n3. **SW hazard detection** (wrong register, wrong stages):\n   - Old: `reg_selb_id = reg_sela_wb` \u2014 compared base register against WB stage only\n   - New: checks `reg_sela_id` (data register) against ALU, MEM, AND WB stages, with `regctl != \"000\"` guard\n   - Purely combinational: auto-sustains as producer advances through stages (3 stall cycles total)\n\n4. **LW stall counter**: \"10\" \u2192 \"01\" (3 stall cycles was 1 too many, 2 sufficient)\n\n5. **BHLEQ added** to branch stall logic (was BZ-only)\n\n6. **Port changes**: Removed `bz_flag`, `reg_selb_alu`; Added `bhleqtrue`, `regctl_alu`, `reg_sela_mem`, `regctl_mem`, `regctl_wb`\n\n### ANEM.vhd Port Map Update\nUpdated hazard unit instantiation with new ports:\n- `bhleqtrue => p_bhleqtrue`\n- `regctl_alu => p_id_wb_regctl_1`\n- `reg_sela_mem => p_id_wb_regsela_2`\n- `regctl_mem => p_id_wb_regctl_2`\n- `regctl_wb => p_id_wb_regctl_3`\n\n### Test Program Optimization (`tests/test_basic.asm`)\nRewrote test to rely on forwarding + hazard detection:\n- Removed all NOPs between ALU operations (forwarding handles dependencies)\n- Removed all NOPs before SW instructions (hazard unit auto-stalls)\n- Kept 3 NOPs after LIL setup block (no LIL forwarding yet \u2014 Phase 3)\n- LIW\u2192SW works with zero NOPs (SW stall detects LIU/LIL in pipeline)\n\n## Verification Results\nAll 9 tests pass with correct values. Execution reduced from 125 cycles (Phase 1 w/ NOPs) to 69 cycles.\n\n## Key Design Decisions\n\n### SW Stall: Combinational Multi-Stage Detection\nRather than using a counter (like LW), the SW stall checks all 3 downstream stages combinationally. As the producer advances through ALU\u2192MEM\u2192WB, the detection automatically shifts to the next stage. This gives exactly 3 stall cycles without a counter, matching the number of NOPs previously needed.\n\n### LW Stall: Clocked Detection + Counter\nThe LW stall uses clocked detection (fires 1 cycle after LW enters ALU). The counter \"01\" extends for 1 additional cycle, giving 2 total stall cycles. This is sufficient because:\n- Cycle 1 (detection): LW in MEM, dependent frozen in ID\n- Cycle 2 (counter): LW in WB (writes on SUBCK), dependent frozen\n- Cycle 3 (release): Dependent enters ALU, register bank has correct value\n\n### BZ/BHLEQ Stall Kept\nThe branch stall (counter \"01\", 2 cycles) was kept for safety even though the flush+bubble mux may handle it alone. Could be optimized away in a future phase.\n\n## Files Changed\n- `control/hazunit.vhd` \u2014 Complete rewrite (139 \u2192 126 lines)\n- `ANEM/ANEM.vhd` \u2014 Hazard unit port map update (lines 840-865)\n- `tests/test_basic.asm` \u2014 Optimized test (140 \u2192 68 lines)\n\n## Remaining Issues (Phase 3+)\n- No forwarding for LIL/LIU immediate values (3 NOPs still needed after LIL)\n- No forwarding for LW data (ALU output forwarded, not memory data)\n- BZ flag timing: uses `p_alu_mem_z_2` which may be stale\n- BZ/BHLEQ stall may be unnecessary (flush+bubble sufficient)\n\n## Annotations\n- Phase 2: `ann_011958_3e7cky4fd06c` (INPROGRESS \u2192 ready to close)\n- Phase 3: `ann_012001_3e7ckyf987fb` (TODO \u2014 forwarding coverage)\n- Phase 4: `ann_012004_3e7cky1b6e23` (TODO \u2014 ALU/register bank fixes)\n- Phase 5: `ann_012006_3e7cky3aa2fe` (TODO \u2014 MAC peripheral fixes)\n",
    "context": "Completed Phase 2 hazard unit rewrite and verification",
    "repository_id": "github.com/brunosmmm/anem16pipe",
    "session_id": "20260206_011215_17b0",
    "session_type": "Software Development",
    "title": "Phase 2 hazard unit complete"
  },
  "entity_id": "20260206_0221_phase-2-hazard-unit-complete",
  "lamport_clock": 24,
  "operation_id": "op_20260206_022113_175a868c",
  "operation_type": "checkpoint_save",
  "parent_operation": null,
  "timestamp": "2026-02-06T02:21:13.928652+00:00"
}