{
  "author": {
    "email": "brunosmmm@gmail.com",
    "name": "Bruno Morais"
  },
  "data": {
    "branch": "master",
    "content": "# Phase 8: WB\u2192ID Timing Hazard Fixes \u2014 Complete\n\n## Problem\nRunning 8 simulator test programs through GHDL trace comparison revealed 3 failures:\n- test_branches_hw: BZ loop off-by-one (counter=6 instead of 5)\n- test_branches_hw: BHLEQ not taken when HI==LO\n- test_subroutine: infinite loop (126 MW events instead of 4)\n\n## Root Cause\nWB\u2192ID timing hazard: when WB writes a register at the same `rising_edge(CK)` as ID reads it (distance 3 in pipeline), VHDL signal assignment schedules the new value for delta cycle 1, but the combinational read at delta cycle 0 gets the stale pre-write value.\n\n## Three Fixes\n1. **regbnk.vhd**: Write-through bypass muxes on A_OUT/B_OUT \u2014 detects simultaneous read/write and outputs write data directly for full-word writes (\"001\"=R/S, \"100\"=LW, \"110\"=MFHI, \"111\"=MFLO)\n2. **ANEM.vhd**: HI/LO write-through bypass muxes (p_id_wb_hiout_0_mux, p_id_wb_loout_0_mux) with byte-merge logic for partial M1 writes (LHH, LHL, LLH, LLL)\n3. **hazunit.vhd**: JR stall detection \u2014 stalls when JR's source register matches a producer in ALU/MEM stage (WB handled by register bank bypass)\n\n## Verification\n- All 32 assertion-based tests pass (23 basic + 4 branch + 5 hazard)\n- All 9 simulator test programs match GHDL traces exactly:\n  test_branches, test_branches_hw, test_fibonacci, test_hilo, test_memory, test_sgt_bz, test_shifts, test_sort, test_subroutine\n\n## Key Insight\nForwarding only covers ALU\u2192ALU (distance 1) and MEM\u2192ALU (distance 2). Distance 3 (WB\u2192ID) requires either a write-through bypass in the register bank or a stall to prevent the overlap. JR is special because it reads registers at ID stage (not ALU), so no forwarding can help \u2014 must stall.\n",
    "context": "Completed Phase 8: WB\u2192ID timing hazard fixes, verified all simulator test programs match GHDL",
    "repository_id": "github.com/brunosmmm/anem16pipe",
    "session_id": "20260206_145924_da5c",
    "session_type": "Debugging",
    "title": "phase8-wb-id-bypass-complete"
  },
  "entity_id": "20260206_2058_phase8-wb-id-bypass-complete",
  "lamport_clock": 120,
  "operation_id": "op_20260206_205827_6ff92fdc",
  "operation_type": "checkpoint_save",
  "parent_operation": null,
  "timestamp": "2026-02-06T20:58:27.946066+00:00"
}