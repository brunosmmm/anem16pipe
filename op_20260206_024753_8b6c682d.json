{
  "author": {
    "email": "brunosmmm@gmail.com",
    "name": "Bruno Morais"
  },
  "data": {
    "branch": "master",
    "content": "\n# Phase 3: Forwarding Coverage \u2014 Complete\n\n## Commit: a64014e\n\n## What Was Done\n\n### 1. ANEM.vhd \u2014 Forwarding enables + LW data forwarding + Z flag gating\n\n**Forwarding enables restricted:**\n- MEM stage (`p_f_regbnk_w_mem`): Only enables for regctl=\"001\" (R/S-type ALU results)\n- WB stage (`p_f_regbnk_w_wb`): Enables for regctl=\"001\" (R/S) OR \"100\" (LW)\n- Previously enabled for ANY regctl != \"000\", which forwarded garbage ALU output for LIL/LIU/JAL\n\n**WB forwarding data mux (`p_f_wb_fwd_data`):**\n- New signal selects between `p_alu_wb_aluout_3` (R/S-type) and `p_mem_wb_memout_3` (LW memory data)\n- Forwarding muxes updated to use `p_f_wb_fwd_data` instead of `p_alu_wb_aluout_3` for WB path\n\n**Z flag gating (`p_z_en`):**\n- Z flag register only updates when aluctl = \"001\" (R-type) or \"010\" (S-type)\n- NOPs/bubbles (aluctl=\"000\") no longer corrupt Z flag with '1'\n- Fixes potential BZ flag timing issues from stale Z values\n\n### 2. hazunit.vhd \u2014 Combinational LW stall + NFW stall detection\n\n**LW stall made purely combinational:**\n- Removed LW stall counter entirely\n- 1 stall cycle only \u2014 WB-stage LW forwarding provides data on the next cycle\n- Previously used registered stall (1 cycle late!) + counter \"01\"\n\n**NFW (non-forwardable write) stall added:**\n- Detects LIL (regctl=\"011\"), LIU (\"010\"), JAL (\"101\") in ALU/MEM/WB stages\n- Checks both reg_sela_id and reg_selb_id against NFW destination\n- Uses `id_reads_regs` deny-list (renamed from `lw_hazard_verify`)\n- Purely combinational across 3 stages \u2014 auto-sustains as producer advances\n- 3 stall cycles total (NFW traverses ALU\u2192MEM\u2192WB, register bank write completes)\n\n### 3. mac/mac.vhd \u2014 Bus contention fix\n\n- MAC peripheral was driving data bus with 0x0000 for ALL reads (REN='1')\n- Now only drives bus when address matches a MAC register (MAC_REG_SEL /= SEL_REG_NONE)\n- This was a pre-existing bug exposed by the new LW test\n\n### 4. test_basic.asm \u2014 Removed NOPs, added LW test\n\n- Removed 3 NOPs after LIL setup block (NFW stalls handle dependencies)\n- Added test 10: `LW $13, 0($0)` \u2192 `ADD $13, $0` \u2192 `SW $13, 9($0)`\n  - Tests LW immediately followed by dependent instruction\n  - Validates LW\u2192WB forwarding path\n- All 10 tests pass, 74 cycles total\n\n## Key Design Decisions\n\n1. **LW stall is 1 cycle (combinational), not 2 (registered+counter):**\n   - The old registered approach was fundamentally broken \u2014 stall signal arrived 1 delta cycle late, allowing the dependent to slip through\n   - With WB forwarding for LW data, only 1 stall cycle is needed\n   - Dependent enters ALU while LW is in WB \u2192 forwarding provides correct data\n\n2. **NFW stall uses combinational multi-stage check (like SW stall):**\n   - No counter needed \u2014 combinational logic checks all 3 stages simultaneously\n   - As NFW advances through pipeline, different stage matches sustain the stall\n   - After NFW exits WB, register bank write has completed, dependent reads correct value\n\n3. **Z flag gated to R/S-type only (not just \"aluctl != 000\"):**\n   - BZ addr calc (\"011\") and SW/LW addr calc (\"100\") produce meaningless Z values\n   - Only R-type and S-type ALU operations produce semantically meaningful Z flags\n\n## LW Address Calculation Discovery\n\n- LW format: `0011|Rd[11:8]|Rs[7:4]|Off[3:0]` \u2014 has a base register!\n- ALU computes: address = zero-extended offset + ALU_B (base register from SELB)\n- ALU_A is overridden inside ALU for aluctl=\"100\": `aux_A <= zero2&func`\n- Forwarding of ALU_B (base register) works correctly through existing forwarding mux\n\n## Remaining Work (Phase 4+)\n\n- Phase 4: ALU/register bank fixes\n- Phase 5: MAC peripheral fixes (bus contention already partially fixed here)\n- BZ flag timing: p_alu_mem_z_2 may still be stale in some edge cases \u2014 Z gating helps but doesn't fully solve chained BZ after non-ALU instructions\n",
    "context": "Completed Phase 3 implementation and committed (a64014e)",
    "repository_id": "github.com/brunosmmm/anem16pipe",
    "session_id": "20260206_011215_17b0",
    "session_type": "Software Development",
    "title": "Phase 3 forwarding coverage complete"
  },
  "entity_id": "20260206_0247_phase-3-forwarding-coverage-complete",
  "lamport_clock": 35,
  "operation_id": "op_20260206_024753_8b6c682d",
  "operation_type": "checkpoint_save",
  "parent_operation": null,
  "timestamp": "2026-02-06T02:47:53.050817+00:00"
}